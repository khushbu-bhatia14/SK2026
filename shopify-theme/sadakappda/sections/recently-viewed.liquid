{% comment %}
  Recently Viewed Products Section
  Uses localStorage to track and display recently viewed products
{% endcomment %}

<section class="section recently-viewed" data-recently-viewed>
  <div class="container">
    <div class="section__header">
      <h2 class="section__title">{{ section.settings.title | default: 'Recently Viewed' }}</h2>
      {%- if section.settings.subtitle != blank -%}
        <p class="section__subtitle">{{ section.settings.subtitle }}</p>
      {%- endif -%}
    </div>
    
    <div class="recently-viewed__grid" data-recently-viewed-grid>
      {%- comment %} Products will be injected here via JavaScript {% endcomment -%}
      {%- comment %} Show placeholder products in Theme Editor {% endcomment -%}
      {%- if request.design_mode -%}
        {%- for i in (1..4) -%}
          <div class="product-card">
            <div class="product-card__image">
              {{ 'product-' | append: i | placeholder_svg_tag: 'placeholder-svg' }}
              <div class="product-card__badges">
                {%- if i == 1 -%}
                  <span class="badge badge--sale">20% OFF</span>
                {%- endif -%}
              </div>
            </div>
            <div class="product-card__info">
              <h3 class="product-card__title">Sample Product {{ i }}</h3>
              <div class="product-card__price">
                <span class="product-card__price-current">₹999</span>
                {%- if i == 1 -%}
                  <span class="product-card__price-compare">₹1,249</span>
                {%- endif -%}
              </div>
            </div>
          </div>
        {%- endfor -%}
      {%- endif -%}
    </div>
    
    <p class="recently-viewed__empty" data-recently-viewed-empty style="display: none;">
      {{ section.settings.empty_message | default: "You haven't viewed any products yet. Start exploring!" }}
    </p>
  </div>
</section>

<style>
  .recently-viewed {
    padding: 4rem 0;
  }
  
  .recently-viewed__grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1.5rem;
  }
  
  .recently-viewed__empty {
    text-align: center;
    padding: 3rem;
    background: var(--color-secondary-bg);
    border-radius: var(--border-radius);
    color: rgba(128, 128, 128, 0.7);
  }
  
  .recently-viewed .product-card {
    background: var(--color-body-bg);
    border-radius: var(--border-radius);
    overflow: hidden;
    transition: transform 0.3s, box-shadow 0.3s;
  }
  
  .recently-viewed .product-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.1);
  }
  
  .recently-viewed .product-card__image {
    position: relative;
    aspect-ratio: 3/4;
    background: var(--color-secondary-bg);
    overflow: hidden;
  }
  
  .recently-viewed .product-card__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s;
  }
  
  .recently-viewed .product-card:hover .product-card__image img {
    transform: scale(1.05);
  }
  
  .recently-viewed .product-card__badges {
    position: absolute;
    top: 0.75rem;
    left: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }
  
  .recently-viewed .product-card__info {
    padding: 1rem;
  }
  
  .recently-viewed .product-card__title {
    font-size: 0.9375rem;
    font-weight: 500;
    margin: 0 0 0.5rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .recently-viewed .product-card__title a {
    color: inherit;
    text-decoration: none;
  }
  
  .recently-viewed .product-card__price {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .recently-viewed .product-card__price-current {
    font-weight: 700;
    font-size: 1rem;
  }
  
  .recently-viewed .product-card__price-compare {
    font-size: 0.875rem;
    text-decoration: line-through;
    opacity: 0.5;
  }
  
  .placeholder-svg {
    width: 100%;
    height: 100%;
    background: #f0f0f0;
  }
  
  @media (max-width: 1024px) {
    .recently-viewed__grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }
  
  @media (max-width: 768px) {
    .recently-viewed {
      padding: 3rem 0;
    }
    
    .recently-viewed__grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const STORAGE_KEY = 'sadakappda_recently_viewed';
  const MAX_PRODUCTS = {{ section.settings.products_to_show | default: 4 }};
  const grid = document.querySelector('[data-recently-viewed-grid]');
  const emptyMessage = document.querySelector('[data-recently-viewed-empty]');
  
  // Get recently viewed products from localStorage
  function getRecentlyViewed() {
    try {
      return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    } catch (e) {
      return [];
    }
  }
  
  // Save product to recently viewed
  function saveToRecentlyViewed(product) {
    let products = getRecentlyViewed();
    
    // Remove if already exists
    products = products.filter(p => p.id !== product.id);
    
    // Add to beginning
    products.unshift(product);
    
    // Limit to max products
    products = products.slice(0, MAX_PRODUCTS + 1);
    
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(products));
    } catch (e) {
      console.warn('Could not save to localStorage');
    }
  }
  
  // Render recently viewed products
  function renderRecentlyViewed() {
    const products = getRecentlyViewed();
    
    // Don't show current product
    const currentProductId = window.currentProductId || null;
    const filteredProducts = products.filter(p => p.id !== currentProductId).slice(0, MAX_PRODUCTS);
    
    if (filteredProducts.length === 0) {
      if (grid) grid.style.display = 'none';
      if (emptyMessage) emptyMessage.style.display = 'block';
      return;
    }
    
    if (grid) {
      grid.innerHTML = filteredProducts.map(product => `
        <div class="product-card">
          <a href="${product.url}" class="product-card__image">
            <img src="${product.image}" alt="${product.title}" loading="lazy">
            ${product.discount ? `<div class="product-card__badges"><span class="badge badge--sale">${product.discount}% OFF</span></div>` : ''}
          </a>
          <div class="product-card__info">
            <h3 class="product-card__title">
              <a href="${product.url}">${product.title}</a>
            </h3>
            <div class="product-card__price">
              <span class="product-card__price-current">${product.price}</span>
              ${product.comparePrice ? `<span class="product-card__price-compare">${product.comparePrice}</span>` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }
  }
  
  // Initialize
  renderRecentlyViewed();
  
  // Expose function for product pages to use
  window.SadaKappda = window.SadaKappda || {};
  window.SadaKappda.saveToRecentlyViewed = saveToRecentlyViewed;
});
</script>

{% schema %}
{
  "name": "Recently Viewed",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Recently Viewed"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Pick up where you left off"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "label": "Products to show",
      "min": 2,
      "max": 8,
      "step": 1,
      "default": 4
    },
    {
      "type": "text",
      "id": "empty_message",
      "label": "Empty message",
      "default": "You haven't viewed any products yet. Start exploring!"
    }
  ],
  "presets": [
    {
      "name": "Recently Viewed"
    }
  ]
}
{% endschema %}
